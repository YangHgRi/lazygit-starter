<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="{{xtermCss}}" />
    <script src="{{xtermJs}}"></script>
    <script src="{{xtermFitJs}}"></script>
    <script src="{{xtermWebglJs}}"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
        background-color: var(--vscode-editor-background);
        overflow: hidden;
      }
      #terminal {
        width: 100vw;
        height: 100vh;
        transition: opacity 0.1s ease-in-out;
      }
      body.blur #terminal {
        opacity: 0.7;
      }
    </style>
  </head>
  <body>
    <div id="terminal"></div>
    <script>
      const vscode = acquireVsCodeApi();

      const style = getComputedStyle(document.documentElement);
      const getColor = (name) => style.getPropertyValue(name).trim();

      const term = new Terminal({
        cursorBlink: true,
        allowProposedApi: true,
        macOptionIsMeta: true,
        fontFamily: getColor("--vscode-editor-font-family") || 'Consolas, "Courier New", monospace',
        fontSize: parseInt(getColor("--vscode-editor-font-size")) || 14,
        lineHeight: 1.2,
        theme: {
          background: getColor("--vscode-editor-background"),
          foreground: getColor("--vscode-editor-foreground"),
          cursor: getColor("--vscode-terminal-cursor-foreground"),
          selectionBackground: getColor("--vscode-terminal-selectionBackground"),
          black: getColor("--vscode-terminal-ansiBlack"),
          red: getColor("--vscode-terminal-ansiRed"),
          green: getColor("--vscode-terminal-ansiGreen"),
          yellow: getColor("--vscode-terminal-ansiYellow"),
          blue: getColor("--vscode-terminal-ansiBlue"),
          magenta: getColor("--vscode-terminal-ansiMagenta"),
          cyan: getColor("--vscode-terminal-ansiCyan"),
          white: getColor("--vscode-terminal-ansiWhite"),
          brightBlack: getColor("--vscode-terminal-ansiBrightBlack"),
          brightRed: getColor("--vscode-terminal-ansiBrightRed"),
          brightGreen: getColor("--vscode-terminal-ansiBrightGreen"),
          brightYellow: getColor("--vscode-terminal-ansiBrightYellow"),
          brightBlue: getColor("--vscode-terminal-ansiBrightBlue"),
          brightMagenta: getColor("--vscode-terminal-ansiBrightMagenta"),
          brightCyan: getColor("--vscode-terminal-ansiBrightCyan"),
          brightWhite: getColor("--vscode-terminal-ansiBrightWhite"),
        },
      });

      const fitAddon = new FitAddon.FitAddon();
      term.loadAddon(fitAddon);

      try {
        const webglAddon = new WebglAddon.WebglAddon();
        term.loadAddon(webglAddon);
      } catch (e) {
        console.warn("WebGL addon could not be loaded, falling back to standard rendering", e);
      }

      term.open(document.getElementById("terminal"));
      term.focus();

      document.body.addEventListener("click", () => {
        term.focus();
      });

      window.addEventListener("focus", () => {
        document.body.classList.remove("blur");
        term.focus();
      });

      window.addEventListener("blur", () => {
        document.body.classList.add("blur");
      });

      let resizeTimeout;
      function handleResize() {
        fitAddon.fit();
        vscode.postMessage({
          command: "resize",
          cols: term.cols,
          rows: term.rows,
        });
      }

      window.addEventListener("resize", () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(handleResize, 100);
      });

      term.onData((data) => {
        vscode.postMessage({ command: "data", data });
      });

      window.addEventListener("message", (event) => {
        const message = event.data;
        if (message.command === "data") {
          term.write(message.data);
        } else if (message.command === "set-state") {
          vscode.setState(message.state);
        }
      });

      handleResize();
      vscode.postMessage({ command: "ready" });
    </script>
  </body>
</html>
